{{#layout}}
{{PAGE_TITLE=Starflow Local}}
{{PAGE_DESCRIPTION=Local info for your town.}}
{{SITE_TITLE=Starflow Local}}
{{SITE_TAGLINE=Helpful local info. No hype, just answers.}}

<!-- Breadcrumbs schema -->
<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"BreadcrumbList",
  "itemListElement":[
    {"@type":"ListItem","position":1,"name":"Home","item":"https://local.starflow.uk/"},
    {"@type":"ListItem","position":2,"name":"UK Index","item":"https://local.starflow.uk/uk/"},
    {"@type":"ListItem","position":3,"name":"{{TOWN}}","item":"https://local.starflow.uk/{{TOWN_SLUG}}/"},
    {"@type":"ListItem","position":4,"name":"{{TITLE}}","item":"{{PAGE_CANONICAL}}"}
  ]
}
</script>

<nav class="muted" style="margin:10px 0 4px;">
  <a href="/{{TOWN_SLUG}}/">← Back to {{TOWN}}</a>
</nav>

<div class="card" style="margin:10px 0 18px;">
  <h2 style="margin-bottom:.35rem;">{{TITLE}}</h2>
  <p class="muted" style="margin:0;">{{DESCRIPTION}}</p>
</div>

<!-- Minimal Share Bar (progressive enhancement: real HREFs + JS enhancements) -->
<div class="sharebar" data-utmcampaign="{{TOWN_SLUG}}">
  <!-- These links work even without JS -->
  <a class="shr" id="share-native"   href="{{PAGE_CANONICAL}}" target="_blank" rel="noopener">Share</a>
  <a class="shr" id="share-whatsapp" href="https://api.whatsapp.com/send?text={{PAGE_CANONICAL}}" target="_blank" rel="noopener">WhatsApp</a>
  <a class="shr" id="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u={{PAGE_CANONICAL}}" target="_blank" rel="noopener">Facebook</a>
  <a class="shr" id="share-copy"     href="{{PAGE_CANONICAL}}" target="_blank" rel="noopener">Copy link</a>
</div>

<!-- Content list/table -->
<div class="table-wrapper">
  {{LIST_HTML}}
</div>

<!-- Share + Schema injection -->
<script>
/*
  Starflow Local — Share bar + Schema (robust)
  - Links have real HREFs (work without JS). JS adds UTMs + native share + copy.
  - Emits ItemList schema for list pages (soft plays, parks, pharmacies, etc.).
  - Emits Event schema for “Free this weekend” pages.
*/
(function () {
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const heading = $('h2') || $('h1');
  const pageTitle = (heading?.textContent || document.title).trim();
  const isEventsPage = /free this weekend/i.test(pageTitle);

  // ===== Enhance Share Bar (keep links working even if this fails) =====
  (function enhanceShare(){
    const wrap = $('.sharebar'); if (!wrap) return;

    // Build UTM’d URL
    const u = new URL(window.location.href);
    if (!u.searchParams.get('utm_source')) {
      u.searchParams.set('utm_source','site');
      u.searchParams.set('utm_medium','share');
      u.searchParams.set('utm_campaign', wrap.dataset.utmcampaign || 'page');
    }
    const shareUrl = u.toString();
    const shareTitle = pageTitle;

    // Update hrefs with final URLs
    const wa = $('#share-whatsapp');
    if (wa) wa.href = 'https://api.whatsapp.com/send?text=' + encodeURIComponent(shareTitle + ' — ' + shareUrl);

    const fb = $('#share-facebook');
    if (fb) fb.href = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(shareUrl);

    const cp = $('#share-copy');
    if (cp) {
      cp.addEventListener('click', function (e) {
        e.preventDefault();
        (async () => {
          try { await navigator.clipboard.writeText(shareUrl); alert('Link copied'); }
          catch { prompt('Copy link:', shareUrl); }
        })();
      }, { passive:false });
      // keep cp.href as a fallback target for no-JS browsers
    }

    const nat = $('#share-native');
    if (nat) {
      nat.addEventListener('click', function (e) {
        e.preventDefault();
        if (navigator.share) {
          navigator.share({ title: shareTitle, url: shareUrl }).catch(()=>{});
        } else {
          // Fallback to Facebook dialog
          window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(shareUrl), '_blank', 'noopener,noreferrer');
        }
      }, { passive:false });
      // native.href remains as page canonical for no-JS fallback
    }
  })();

  // ===== Collect list items (your pages render them as <ul><li>…</li></ul>) =====
  const lis = $$('.table-wrapper li');
  if (!lis.length) return;

  function firstLineOf(li) {
    return (li.textContent || '')
      .split('\n')
      .map(s => s.trim())
      .filter(Boolean)[0] || '';
  }

  if (isEventsPage) {
    // ===== Event schema for “Free this weekend” =====
    const events = lis.map(li => {
      const a = $('a[href^="http"]', li);
      const line1 = firstLineOf(li);                 // e.g. "2025-09-19 — Heritage Open Days …"
      const dateMatch = line1.match(/^(\d{4}-\d{2}-\d{2})/);
      const dateStr = dateMatch ? dateMatch[1] : '';
      const name = (a?.textContent?.trim()) || line1.replace(/^\d{4}-\d{2}-\d{2}\s*—\s*/,'').trim();

      // Try to capture a venue name like "Various venues · ..."
      const venueLine = (li.textContent || '')
        .split('\n').map(s=>s.trim()).filter(Boolean)
        .find(s => /·/.test(s)) || '';
      const venueName = venueLine ? venueLine.split('·')[0].trim() : '';

      const obj = {
        "@context": "https://schema.org",
        "@type": "Event",
        "name": name,
        "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
        "eventStatus": "https://schema.org/EventScheduled",
        "isAccessibleForFree": true
      };
      if (a) obj.url = a.href;
      if (dateStr) obj.startDate = dateStr; // date-only OK
      if (venueName) obj.location = { "@type": "Place", "name": venueName };
      return obj;
    });

    const s = document.createElement('script');
    s.type = 'application/ld+json';
    s.textContent = JSON.stringify({ "@context":"https://schema.org", "@graph": events });
    document.head.appendChild(s);
    return;
  }

  // ===== ItemList schema for venue lists (Soft play & parks, Pharmacies, etc.) =====
  const items = lis.map((li, i) => {
    const a = $('a[href^="http"]', li);
    let name = firstLineOf(li); // first line is the venue name
    name = name.replace(/\s+(soft_play|park|pharmacy|urgent_care|baby_group)\s*$/i, '').trim();
    return {
      "@type": "ListItem",
      "position": i + 1,
      "name": name || (a?.textContent?.trim()) || document.title,
      ...(a && { "url": a.href })
    };
  });

  const data = {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": pageTitle,
    "itemListElement": items
  };
  const s = document.createElement('script');
  s.type = 'application/ld+json';
  s.textContent = JSON.stringify(data);
  document.head.appendChild(s);
})();
</script>

<style>
.sharebar{display:flex;gap:.5rem;align-items:center;margin:8px 0 16px}
.sharebar .shr{font:inherit;border:1px solid #ddd;border-radius:8px;padding:6px 10px;background:#fff;cursor:pointer;text-decoration:none}
.sharebar .shr:hover{background:#f5f5f5}
</style>
